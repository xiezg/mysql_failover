name: mysqlfailover 
version: "3.4"
services:
  mysql-1:
    image: mysql:5.7.41
    volumes:
      - "${BASE_PATH}/dir1:/var/lib/mysql"
    container_name: mysql-node1
    environment:
      MYSQL_ROOT_PASSWORD: "000000"
    #network_mode: "host"
    command: --server-id=1 --gtid-mode=ON --enforce-gtid-consistency=on --master-info-repository=TABLE --relay-log-info-repository=TABLE --log-slave-updates --log-bin=binlog --relay-log=relaylog --slave-parallel-workers=4 --slave-parallel-type=DATABASE
    ports:
      - target: 3306
        published: 13306
    networks:
      - my_network
  mysql-2:
    image: mysql:5.7.41
    volumes:
      - "${BASE_PATH}/dir2:/var/lib/mysql"
    container_name: mysql-node2
    command: --server-id=2 --gtid-mode=ON --enforce-gtid-consistency=on --master-info-repository=TABLE --relay-log-info-repository=TABLE --log-slave-updates --log-bin=binlog --relay-log=relaylog --slave-parallel-workers=4 --slave-parallel-type=DATABASE
    environment:
      MYSQL_ROOT_PASSWORD: "000000"
    networks:
      - my_network
    ports:
      - target: 3306
        published: 23306
  failover:
    image: ${IMAGE_HOST}/platform/mysql-failover:v0.0.1
    container_name: failover 
    restart: always
    environment:
      DEBUG: "TRUE"
    networks:
      - my_network
  backup:
    image: ${IMAGE_HOST}/platform/xtrabackup:1.0.6
    volumes:
      - "${BASE_PATH}/dir1:/data1/"
      - "${BASE_PATH}/dir2:/data2/"
      - "${BASE_PATH}/backup:/backup/"
    container_name: backup 
    command: sleep 1000d
    networks:
      - my_network
networks:
  my_network:
    driver: bridge
